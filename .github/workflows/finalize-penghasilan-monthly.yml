name: Execute Supabase Edge Function Monthly

on:
  schedule:
    # Setiap tanggal 1 jam 05:00 UTC (12:00 WIB = 05:00 UTC)
    # Format: menit jam tanggal bulan hari-minggu
    - cron: '0 5 1 * *'
  
  # Untuk manual trigger dari GitHub UI
  workflow_dispatch:
    inputs:
      log_level:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
        - info
        - warning
        - debug

jobs:
  call-edge-function:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository (optional)
      uses: actions/checkout@v4
      
    - name: Call Supabase Edge Function
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        echo "üïê Executing at: $(date)"
        echo "üåç Timezone: UTC (12:00 WIB = 05:00 UTC)"
        
        # Panggil Edge Function
        response=$(curl -s -w "\n%{http_code}" -X POST \
          "$SUPABASE_URL/functions/v1/finalize-penghasilan-monthly" \
          -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
          -H "Content-Type: application/json" \
          -H "User-Agent: GitHub-Actions" \
          -d '{"source": "github-cron", "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"}')
        
        # Pisahkan response body dan status code
        http_code=$(echo "$response" | tail -n1)
        response_body=$(echo "$response" | sed '$d')
        
        echo "üì° Status Code: $http_code"
        echo "üì¶ Response: $response_body"
        
        # Jika status bukan 2xx, gagalkan workflow
        if [[ $http_code -lt 200 || $http_code -ge 300 ]]; then
          echo "‚ùå Edge Function call failed!"
          exit 1
        fi
        
        echo "‚úÖ Edge Function executed successfully!"
        
    - name: Send notification on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'finalize-penghasilan-monthly.yml',
            ref: 'main'
          })
